# simulator.py의 _schedule_prefill()와 _schedule_decode() 수정:

def _schedule_prefill(self):
    """Schedule a prefill batch with dynamic memory-based sizing."""
    
    # Memory checker function
    def memory_checker(requests, is_prefill):
        return self.memory_manager.can_schedule_batch(requests, is_prefill)
    
    # Let scheduler dynamically size the batch based on memory
    batch = self.scheduler.schedule_prefill_batch(
        self.current_time,
        memory_checker=memory_checker  # NEW!
    )
    
    if batch is None:
        return
    
    # Rest of the code stays the same...
    self.is_gpu_busy = True
    # ...

def _schedule_decode(self):
    """Schedule a decode batch with dynamic memory-based sizing."""
    
    # Memory checker function
    def memory_checker(requests, is_prefill):
        return self.memory_manager.can_schedule_batch(requests, is_prefill)
    
    # Let scheduler dynamically size the batch based on memory
    batch = self.scheduler.schedule_decode_batch(
        self.current_time,
        memory_checker=memory_checker  # NEW!
    )
    
    if batch is None:
        return
    
    # Rest of the code stays the same...
